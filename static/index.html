<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Economy Core | 工业级数值控制台</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        [v-cloak] { display: none !important; }
        body { 
            font-family: 'Inter', system-ui, -apple-system, sans-serif; 
            background-color: #f8fafc; color: #334155;
            -webkit-font-smoothing: antialiased;
        }
        /* 数字使用等宽字体，对齐更美观 */
        .font-mono { font-family: 'JetBrains Mono', monospace; }

        /* --- 动态背景动画 --- */
        .ambient-bg { position: fixed; inset: 0; z-index: 0; pointer-events: none; overflow: hidden; }
        .ambient-blob { position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.4; will-change: transform; }
        .blob-1 { width: 50vw; height: 50vw; background: #e0e7ff; animation: float1 25s infinite alternate; }
        .blob-2 { width: 60vw; height: 60vw; background: #f0fdf4; animation: float2 30s infinite alternate; right: -10%; bottom: -10%; }
        @keyframes float1 { from { transform: translate(-10%, -10%) scale(1); } to { transform: translate(10%, 5%) scale(1.1); } }
        @keyframes float2 { from { transform: translate(10%, 10%) scale(1); } to { transform: translate(-5%, -5%) scale(1.05); } }

        .bg-grid {
            position: fixed; inset: 0; z-index: 1; pointer-events: none;
            background-image: radial-gradient(circle, #cbd5e1 1px, transparent 1px);
            background-size: 30px 30px; opacity: 0.15;
        }

        /* --- 玻璃拟态卡片 --- */
        .glass-card {
            background: rgba(255, 255, 255, 0.75); 
            backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        /* --- 悬浮提示系统 (Tooltip) --- */
        .info-trigger { cursor: help; border-bottom: 1px dashed #cbd5e1; display: inline-flex; align-items: center; gap: 4px; position: relative; transition: border-color 0.2s; }
        .info-trigger:hover { border-bottom-color: #6366f1; }
        
        .tooltip-box {
            visibility: hidden; position: absolute; 
            z-index: 9999; 
            width: 280px;
            background: rgba(30, 41, 59, 0.98); backdrop-filter: blur(4px); color: #f8fafc; padding: 14px; border-radius: 12px;
            font-size: 12px; line-height: 1.6; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
            opacity: 0; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); bottom: 130%; left: 50%; 
            transform: translateX(-50%) translateY(8px); pointer-events: none;
        }

        .tooltip-box.tooltip-right { left: auto; right: 0; transform: translateY(8px); }
        .tooltip-box.tooltip-left { left: 0; transform: translateY(8px); }
        .tooltip-box::after { content: ''; position: absolute; top: 100%; left: 50%; margin-left: -6px; border-width: 6px; border-style: solid; border-color: rgba(30, 41, 59, 0.98) transparent transparent transparent; }
        .tooltip-box.tooltip-right::after { left: auto; right: 20px; }
        .tooltip-box.tooltip-left::after { left: 20px; }

        .info-trigger:hover .tooltip-box { visibility: visible; opacity: 1; transform: translateX(-50%) translateY(0); }
        .info-trigger:hover .tooltip-box.tooltip-right { transform: translateY(0); }
        .info-trigger:hover .tooltip-box.tooltip-left { transform: translateY(0); }
        .tooltip-box b { color: #818cf8; display: block; margin-bottom: 4px; font-size: 13px; font-weight: 800; }
        .tooltip-box .formula { font-family: 'JetBrains Mono', monospace; background: rgba(255,255,255,0.1); padding: 2px 4px; border-radius: 4px; color: #fbbf24; }

        /* --- 极致滑块样式 --- */
        .modern-slider {
            -webkit-appearance: none; appearance: none;
            width: 100%; height: 6px; background: #e2e8f0; border-radius: 10px;
            outline: none; transition: all 0.3s; cursor: pointer;
        }
        .modern-slider:hover { background: #c7d2fe; }
        
        .modern-slider::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 20px; height: 20px; 
            background: #6366f1; border: 3px solid #fff; border-radius: 50%;
            cursor: grab; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s ease-out;
        }
        .modern-slider::-moz-range-thumb {
            width: 16px; height: 16px;
            background: #6366f1; border: 3px solid #fff; border-radius: 50%;
            cursor: grab; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s ease-out; border: none;
        }
        
        .modern-slider::-webkit-slider-thumb:hover { transform: scale(1.2); background: #4f46e5; box-shadow: 0 0 0 8px rgba(99, 102, 241, 0.25); }
        .modern-slider:active::-webkit-slider-thumb { transform: scale(1.3); cursor: grabbing; background: #4338ca; box-shadow: 0 0 0 12px rgba(99, 102, 241, 0.35); }

        .sidebar-item.active { background: #ffffff; box-shadow: 0 4px 12px -2px rgba(99, 102, 241, 0.12); border-right: 3px solid #6366f1; }
        .neff-bar { height: 3px; background: #e2e8f0; border-radius: 2px; overflow: hidden; margin-top: 8px; }
        .neff-fill { height: 100%; background: #6366f1; transition: width 0.5s ease; }
        .skeleton { background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%); background-size: 200% 100%; animation: shimmer 2s infinite; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        
        .toast-enter-active, .toast-leave-active { transition: all 0.4s ease; }
        .toast-enter-from { opacity: 0; transform: translateX(30px); }
        .toast-leave-to { opacity: 0; transform: translateY(30px); }
    </style>
</head>
<body>

    <div class="ambient-bg">
        <div class="ambient-blob blob-1"></div>
        <div class="ambient-blob blob-2"></div>
    </div>
    <div class="bg-grid"></div>

    <div id="app" class="relative z-10 flex w-full h-screen overflow-hidden" v-cloak>
        
        <aside class="w-80 bg-slate-50/50 backdrop-blur-xl border-r border-slate-200 flex flex-col z-20">
            <div class="p-6 border-b border-slate-200 bg-white/40">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center shadow-lg text-white">
                        <i data-lucide="terminal" class="w-5 h-5"></i>
                    </div>
                    <div>
                        <h1 class="font-black text-slate-900 text-lg leading-none tracking-tight">Economy Core</h1>
                        <span class="text-[10px] font-mono text-slate-400 uppercase tracking-widest">Version 5.3</span>
                    </div>
                </div>
                <div class="relative">
                    <i data-lucide="search" class="absolute left-3 top-3 w-4 h-4 text-slate-400"></i>
                    <input v-model="searchQuery" placeholder="快速定位商品指纹..." 
                           class="w-full bg-white border border-slate-200 rounded-lg pl-10 pr-4 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500/20 transition-all">
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-4 space-y-2">
                <div v-if="loading" class="space-y-3">
                    <div v-for="i in 5" class="h-16 skeleton rounded-lg"></div>
                </div>
                <div v-for="item in filteredItems" :key="item.id" 
                     @click="selectItem(item)"
                     class="sidebar-item group p-4 rounded-xl cursor-pointer transition-all hover:bg-white/60"
                     :class="{'active': activeItem.id === item.id}">
                    <div class="flex justify-between items-start mb-2">
                        <span class="font-bold text-sm text-slate-700 group-hover:text-indigo-600">{{ item.name }}</span>
                        <span class="text-[9px] font-mono bg-slate-200 px-1.5 py-0.5 rounded text-slate-500 uppercase">{{ item.id.split(':')[1] || 'item' }}</span>
                    </div>
                    <div class="flex justify-between items-center text-[10px]">
                        <span class="text-slate-400 font-medium">Neff: <span class="font-mono">{{ Math.round(item.n) }}</span></span>
                        <span class="text-indigo-600 font-bold tracking-tighter">P₀: <span class="font-mono">{{ item.basePrice.toFixed(1) }}</span></span>
                    </div>
                    <div class="neff-bar">
                        <div class="neff-fill" :style="{ width: Math.min(100, (item.n / 1000) * 100) + '%', backgroundColor: getNeffColor(item.n) }"></div>
                    </div>
                </div>
            </div>

            <div class="p-4 bg-white/40 border-t border-slate-200">
                <div class="flex items-center justify-between text-[10px] font-black text-slate-400 tracking-tighter uppercase">
                    <span>Server Status</span>
                    <span :class="serverStatus ? 'text-emerald-500' : 'text-red-500'">● {{ serverStatus ? 'Online' : 'Offline' }}</span>
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col overflow-hidden">
            <header class="h-16 border-b border-slate-200 bg-white/80 backdrop-blur-md flex justify-between items-center px-8 shrink-0 z-30">
                <nav class="flex gap-1 p-1 bg-slate-100 rounded-xl">
                    <button @click="currentTab = 'simulation'" 
                            class="px-5 py-1.5 rounded-lg text-[10px] font-black transition-all uppercase tracking-wider"
                            :class="currentTab === 'simulation' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500 hover:text-slate-900'">
                        行情模拟预测
                    </button>
                    <button @click="currentTab = 'config'" 
                            class="px-5 py-1.5 rounded-lg text-[10px] font-black transition-all uppercase tracking-wider"
                            :class="currentTab === 'config' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500 hover:text-slate-900'">
                        全局经济策略
                    </button>
                </nav>

                <div class="flex items-center gap-8">
                    <div class="text-right">
                        <div class="info-trigger text-[9px] font-black text-slate-400 uppercase tracking-widest block mb-0.5">
                            Live Environment Factor ε
                            <div class="tooltip-box tooltip-right">
                                <b>当前环境因子 (ε)</b>
                                这是一个全局实时变量，由后端基于节假日、季节周期及随机波动算法生成。
                                <br>• ε > 1.0: 市场溢价 (通胀)
                                <br>• ε < 1.0: 市场折价 (紧缩)
                            </div>
                        </div>
                        <div class="flex items-center gap-2 justify-end">
                            <span class="text-2xl font-mono font-black text-slate-900 tracking-tighter">{{ currentEnv.toFixed(4) }}</span>
                            <div class="px-2 py-0.5 rounded-full bg-indigo-600 text-white text-[9px] font-black uppercase">{{ envNote }}</div>
                        </div>
                    </div>
                </div>
            </header>

            <div class="flex-1 relative overflow-hidden bg-slate-50/30 p-8">
                
                <div v-show="currentTab === 'simulation'" class="absolute inset-0 p-8 flex gap-8">
                    <div class="w-80 flex flex-col gap-6">
                        <div class="glass-card rounded-3xl p-6 shadow-sm">
                            <h3 class="text-[10px] font-black text-indigo-400 uppercase mb-5 flex items-center gap-2">
                                <i data-lucide="database" class="w-3 h-3"></i> 物资即时快照
                            </h3>
                            <div v-if="activeItem.id" class="space-y-5">
                                <div>
                                    <div class="text-2xl font-black text-slate-900 tracking-tight leading-tight">{{ activeItem.name }}</div>
                                    <div class="text-[9px] text-slate-400 font-mono uppercase bg-slate-100 px-2 py-1 rounded inline-block mt-2 tracking-tighter">{{ activeItem.id }}</div>
                                </div>
                                <div class="grid gap-3">
                                    <div class="bg-indigo-600 rounded-2xl p-4 text-white shadow-xl shadow-indigo-100">
                                        <div class="info-trigger text-[9px] font-black opacity-80 mb-1 uppercase tracking-widest flex justify-between w-full" style="border-bottom-color: rgba(255,255,255,0.3)">
                                            结算价 (SELL)
                                            <div class="tooltip-box">
                                                <b>最终收购定价</b>
                                                系统从玩家手中回收物资的价格。<br>
                                                <span class="formula">P_sell = ε · P_base · e^(-λ · Neff)</span>
                                            </div>
                                        </div>
                                        <div class="text-2xl font-mono font-black">{{ currentPrice.toFixed(2) }} <span class="text-xs opacity-60 ml-1">⛁</span></div>
                                    </div>
                                    <div class="bg-white border border-slate-200 rounded-2xl p-4 flex justify-between items-center shadow-sm">
                                        <div>
                                            <div class="info-trigger text-[9px] font-black text-slate-400 uppercase tracking-widest">
                                                买入价 (BUY)
                                                <div class="tooltip-box tooltip-left">
                                                    <b>申购报价</b>
                                                    系统售出给玩家的价格。<br>
                                                    <span class="formula">Buy = Sell · Spread</span>
                                                </div>
                                            </div>
                                            <div class="text-lg font-mono font-black text-slate-800 tracking-tighter">{{ buyPrice.toFixed(2) }}</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-[9px] font-black text-slate-400 uppercase tracking-widest text-right">有效库存</div>
                                            <div class="text-lg font-mono font-black text-indigo-600 tracking-tighter">{{ simN.toFixed(1) }}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div v-else class="py-16 flex flex-col items-center justify-center text-slate-300 text-[10px] font-bold uppercase tracking-widest border-2 border-dashed border-slate-200 rounded-3xl">
                                <i data-lucide="mouse-pointer-2" class="w-8 h-8 mb-4 opacity-20"></i>
                                Select Item to Load
                            </div>
                        </div>

                        <div class="glass-card rounded-3xl p-6 flex-1 flex flex-col shadow-sm">
                            <h3 class="text-[10px] font-black text-slate-400 uppercase mb-8 flex items-center gap-2 tracking-[0.2em]">
                                <i data-lucide="zap" class="w-3 h-3"></i> 交易规模模拟 (ΔN)
                            </h3>
                            <div class="space-y-8">
                                <div class="space-y-4">
                                    <div class="flex justify-between items-end">
                                        <label class="info-trigger text-[10px] font-black text-slate-500 uppercase tracking-wider">
                                            冲击幅度
                                            <div class="tooltip-box">
                                                <b>Delta N (Δn)</b>
                                                模拟在当前库存基础上，增加或减少一定数量的物资对市场定价造成的冲击波。
                                            </div>
                                        </label>
                                        <div class="text-xs font-mono font-black text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded border border-indigo-100">
                                            {{ tradeAmount }} <span class="text-[9px] opacity-60">UNITS</span>
                                        </div>
                                    </div>
                                    
                                    <div class="relative pt-2">
                                        <input type="range" v-model.number="tradeAmount" min="1" max="2304" step="1" 
                                               class="modern-slider">
                                        <div class="flex justify-between mt-4 text-[9px] font-bold text-slate-300 uppercase tracking-tighter">
                                            <span>MIN (1)</span>
                                            <span>STACK (64)</span>
                                            <span>MAX (2.3k)</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="grid grid-cols-2 gap-3">
                                    <button @click="simulateTrade('buy')" :disabled="!activeItem.id" 
                                            class="py-3 bg-slate-900 text-white rounded-2xl text-[10px] font-black uppercase tracking-widest hover:bg-slate-800 disabled:opacity-20 hover:scale-[1.02] active:scale-95 transition-all shadow-lg">模拟申购</button>
                                    <button @click="simulateTrade('sell')" :disabled="!activeItem.id" 
                                            class="py-3 bg-white text-slate-900 border-2 border-slate-200 rounded-2xl text-[10px] font-black uppercase tracking-widest hover:bg-slate-50 disabled:opacity-20 hover:scale-[1.02] active:scale-95 transition-all">模拟抛售</button>
                                </div>

                                <div v-if="simResult" class="mt-auto p-4 bg-emerald-50 border border-emerald-100 rounded-2xl flex justify-between items-center animate-pulse">
                                    <span class="text-[10px] font-black text-emerald-700 uppercase tracking-widest">预估成交总额</span>
                                    <span class="text-xl font-mono font-black text-emerald-600 tracking-tighter">{{ simResult.totalPrice.toFixed(2) }}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex-1 glass-card rounded-3xl p-8 flex flex-col relative overflow-hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] flex items-center gap-2">
                                <i data-lucide="trending-down" class="w-3 h-3"></i> 指数衰减定价曲线
                            </h3>
                            <div v-if="activeItem.id" class="info-trigger text-[10px] px-3 py-1.5 bg-indigo-50 text-indigo-600 rounded-lg font-mono font-bold">
                                λ = {{ activeItem.lambda }}
                                <div class="tooltip-box tooltip-right">
                                    <b>价格敏感度 (Decay Lambda)</b>
                                    该系数控制价格随库存增加而下跌的“陡峭度”。<br>
                                    λ 越大，价格崩盘速度越快。
                                </div>
                            </div>
                        </div>
                        <div id="priceChart" class="flex-1 w-full h-full min-h-[400px]"></div>
                    </div>
                </div>

                <div v-show="currentTab === 'config'" class="absolute inset-0 p-12 overflow-y-auto">
                    <div class="max-w-4xl mx-auto space-y-12">
                        <div class="flex justify-between items-end border-b border-slate-200 pb-10">
                            <div>
                                <h2 class="text-4xl font-black text-slate-900 tracking-tight italic">Global Macro Policy</h2>
                                <p class="text-slate-500 text-sm mt-3 font-medium">调整 Rust 计算核心的全局定价权重、衰减恢复率以及市场准入因子。</p>
                            </div>
                            <button @click="saveConfig" class="px-8 py-3.5 bg-indigo-600 text-white rounded-2xl font-black text-[10px] uppercase tracking-widest shadow-2xl shadow-indigo-200 hover:scale-110 active:scale-95 transition-all">
                                覆盖远程核心数据
                            </button>
                        </div>
                        
                        <div v-if="config" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div v-for="(group, gIdx) in configGroups" :key="gIdx" class="glass-card p-8 rounded-[2rem] space-y-8">
                                <h4 class="text-[10px] font-black text-indigo-500 uppercase tracking-[0.3em] mb-4 flex items-center gap-3">
                                    <i :data-lucide="group.icon" class="w-4 h-4"></i> {{ group.title }}
                                </h4>
                                <div v-for="field in group.fields" :key="field.key" class="space-y-3">
                                    <label class="info-trigger text-[10px] font-black text-slate-500 uppercase tracking-wider flex items-center gap-1">
                                        {{ field.label }}
                                        <div class="tooltip-box"><b>{{ field.label }}</b>{{ field.desc }}</div>
                                    </label>
                                    <input v-model.number="config[field.key]" :step="field.step || 1" 
                                           class="w-full bg-slate-100 border-none rounded-2xl px-5 py-4 font-mono font-black text-slate-900 focus:ring-4 focus:ring-indigo-500/10 outline-none transition-all text-lg">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <div class="fixed bottom-8 right-8 z-50 flex flex-col gap-3 pointer-events-none">
            <transition-group name="toast">
                <div v-for="toast in toasts" :key="toast.id" class="pointer-events-auto bg-slate-900/90 backdrop-blur-xl text-white px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-3 border border-white/10">
                    <div class="w-2 h-2 rounded-full bg-indigo-400 shadow-[0_0_10px_rgba(129,140,248,0.8)]"></div>
                    <span class="text-[10px] font-black uppercase tracking-widest">{{ toast.message }}</span>
                </div>
            </transition-group>
        </div>
    </div>

    <script>
        const { createApp, ref, reactive, onMounted, onUnmounted, computed, watch, nextTick, shallowRef } = Vue;

        createApp({
            setup() {
                const serverStatus = ref(false);
                const loading = ref(true);
                const currentTab = ref('simulation');
                const searchQuery = ref('');
                const config = ref(null);
                const items = shallowRef([]);
                const activeItem = reactive({ id: '', name: '', basePrice: 0, n: 0, lambda: 0 });
                
                const simN = ref(0);
                const currentEnv = ref(1.0);
                const envNote = ref('Normal');
                const currentPrice = ref(0);
                const buyPrice = ref(0);
                const tradeAmount = ref(64);
                const simResult = ref(null);
                const toasts = ref([]);
                
                let myChart = null;

                const configGroups = [
                    { title: "自修复协议 (Auto-Recovery)", icon: "refresh-cw", fields: [
                        { key: "recoveryDelta", label: "修复斜率 (δ)", step: 0.01, desc: "当市场静止时，有效库存(Neff)回归零值的速度。数值越大，价格恢复基准价越快。" },
                        { key: "recoveryTau", label: "时间频率 (τ)", step: 60, desc: "定义物理时间周期长度（秒）。默认为 3600。" }
                    ]},
                    { title: "宏观调控 (Macro Control)", icon: "sliders", fields: [
                        { key: "buyPremium", label: "申购溢价乘数", step: 0.05, desc: "玩家买入价相对于卖出价的溢价倍数。用于回收多余流动性。" },
                        { key: "baseEnvIndex", label: "基础通胀指数 (ε₀)", step: 0.1, desc: "服务器默认的原始环境乘数。" },
                        { key: "globalIota", label: "全域库存偏移 (ι)", step: 10, desc: "人为注入的虚拟库存偏移量。正数全局降价，负数全局提价。" }
                    ]}
                ];

                const filteredItems = computed(() => {
                    const q = searchQuery.value.trim().toLowerCase();
                    return items.value.filter(i => i.name.toLowerCase().includes(q) || i.id.toLowerCase().includes(q));
                });

                const getNeffColor = (n) => {
                    if (n > 2000) return '#ef4444';
                    if (n > 800) return '#f59e0b';
                    return '#6366f1';
                };

                const showToast = (message) => {
                    const id = Date.now();
                    toasts.value.push({ id, message });
                    setTimeout(() => toasts.value = toasts.value.filter(t => t.id !== id), 3000);
                };

                const calculatePrice = (env, base, lambda, n) => {
                    const iota = config.value?.globalIota || 0;
                    return env * base * Math.exp(-Math.abs(lambda) * (n + iota));
                };

                const selectItem = async (item) => {
                    Object.assign(activeItem, item);
                    simResult.value = null;
                    try {
                        const res = await axios.post('/api/market/prices', { item_ids: [item.id] });
                        const data = res.data;
                        const live = data.items[item.id];
                        if (live) {
                            currentEnv.value = data.envIndex;
                            envNote.value = data.envNote;
                            simN.value = live.neff;
                            currentPrice.value = live.price;
                            buyPrice.value = live.buy_price;
                        }
                        renderChart();
                    } catch (e) {
                        showToast("使用本地模拟数据 (离线模式)");
                        simN.value = item.n || 0;
                        currentPrice.value = calculatePrice(currentEnv.value, item.basePrice, item.lambda, simN.value);
                        renderChart();
                    }
                };

                const simulateTrade = (type) => {
                    if (!activeItem.id) return;
                    const delta = type === 'buy' ? -tradeAmount.value : tradeAmount.value;
                    const prevN = simN.value;
                    const prevPrice = currentPrice.value;
                    
                    // 更新模拟库存和价格
                    simN.value = Math.max(0, simN.value + delta);
                    currentPrice.value = calculatePrice(currentEnv.value, activeItem.basePrice, activeItem.lambda, simN.value);
                    buyPrice.value = currentPrice.value * (config.value?.buyPremium || 1.25);
                    
                    // 估算总成交额
                    const unitAvg = (prevPrice + currentPrice.value) / 2;
                    simResult.value = { type, totalPrice: unitAvg * tradeAmount.value };
                    
                    // 刷新图表区域
                    renderChart(type, prevN, tradeAmount.value);
                    showToast(`模拟交易: ${type === 'buy' ? '申购' : '抛售'} ${tradeAmount.value} 个`);
                };

                const renderChart = (action, startN, amount) => {
                    if (!activeItem.id) return;
                    const dom = document.getElementById('priceChart');
                    if (!dom) return;
                    if (!myChart) myChart = echarts.init(dom);
                    
                    const maxN = Math.max(simN.value * 1.5, 500);
                    const plotData = [];
                    for(let x=0; x<=maxN; x += maxN/100) {
                        plotData.push([x, calculatePrice(currentEnv.value, activeItem.basePrice, activeItem.lambda, x)]);
                    }

                    const option = {
                        animationDuration: 1000,
                        tooltip: { trigger: 'axis', backgroundColor: '#fff', borderRadius: 12 },
                        grid: { top: 40, right: 30, bottom: 40, left: 60, containLabel: true },
                        xAxis: { type: 'value', splitLine: { show: false }, axisLine: { lineStyle: { color: '#e2e8f0' } } },
                        yAxis: { type: 'value', splitLine: { lineStyle: { type: 'dashed', color: '#e2e8f0' } } },
                        series: [
                            {
                                type: 'line', data: plotData, smooth: true, showSymbol: false,
                                lineStyle: { width: 4, color: '#6366f1' },
                                areaStyle: { color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{ offset: 0, color: 'rgba(99,102,241,0.15)' }, { offset: 1, color: 'rgba(99,102,241,0)' }])}
                            },
                            {
                                type: 'effectScatter', data: [[simN.value, currentPrice.value]],
                                symbolSize: 15, itemStyle: { color: '#fbbf24', borderWidth: 3, borderColor: '#fff' }
                            }
                        ]
                    };
                    
                    if(action) {
                        const endN = action === 'buy' ? Math.max(0, startN - amount) : startN + amount;
                        const minX = Math.min(startN, endN);
                        const maxX = Math.max(startN, endN);
                        
                        option.series[0].markArea = {
                            itemStyle: { color: action === 'buy' ? 'rgba(244,63,94,0.15)' : 'rgba(16,185,129,0.15)' }, // 买入红/卖出绿
                            data: [[{ xAxis: minX }, { xAxis: maxX }]]
                        };
                    }
                    myChart.setOption(option, true);
                };

                const fetchData = async () => {
                    try {
                        // 尝试从后端获取数据
                        const [mRes, cRes] = await Promise.all([axios.get('/api/market'), axios.get('/api/config')]);
                        items.value = mRes.data;
                        config.value = cRes.data;
                        serverStatus.value = true;
                    } catch (e) {
                        // 后端连接失败时，加载演示用 Mock 数据
                        if (!config.value) {
                            config.value = {
                                recoveryDelta: 0.05, recoveryTau: 3600, buyPremium: 1.25,
                                baseEnvIndex: 1.0, globalIota: 0
                            };
                            items.value = [
                                { id: 'minecraft:diamond', name: 'Diamond', basePrice: 100, n: 50, lambda: 0.005 },
                                { id: 'minecraft:gold_ingot', name: 'Gold Ingot', basePrice: 45, n: 800, lambda: 0.002 },
                                { id: 'minecraft:iron_ingot', name: 'Iron Ingot', basePrice: 15, n: 2500, lambda: 0.001 },
                                { id: 'minecraft:netherite_ingot', name: 'Netherite Ingot', basePrice: 450, n: 10, lambda: 0.008 },
                            ];
                        }
                        serverStatus.value = false; 
                    } finally {
                        loading.value = false;
                    }
                };

                const saveConfig = async () => {
                    try {
                        await axios.post('/api/config', config.value);
                        showToast("配置已同步至核心");
                    } catch { showToast("同步失败 (演示模式)"); }
                };

                onMounted(() => {
                    lucide.createIcons();
                    fetchData();
                    setInterval(fetchData, 10000);
                    window.addEventListener('resize', () => myChart?.resize());
                });

                onUnmounted(() => { if (myChart) myChart.dispose(); });

                return {
                    serverStatus, currentTab, searchQuery, config, items, filteredItems, loading,
                    activeItem, simN, currentEnv, envNote, currentPrice, buyPrice, tradeAmount, simResult, toasts,
                    selectItem, simulateTrade, saveConfig, configGroups, getNeffColor
                };
            }
        }).mount('#app');
    </script>
</body>
</html>