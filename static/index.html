<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Economy Core | 生产级经济监控</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        [v-cloak] { display: none !important; }
        body { 
            background-color: #f8fafc; 
            color: #334155; 
            font-family: 'Inter', system-ui, -apple-system, sans-serif; 
        }

        .bg-grid {
            background-size: 40px 40px;
            background-image: linear-gradient(to right, rgba(0, 0, 0, 0.03) 1px, transparent 1px),
                              linear-gradient(to bottom, rgba(0, 0, 0, 0.03) 1px, transparent 1px);
            mask-image: radial-gradient(circle at center, black 40%, transparent 100%);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .input-modern {
            width: 100%;
            background-color: #ffffff;
            border: 1px solid #cbd5e1;
            border-radius: 0.5rem;
            padding: 0.6rem 0.8rem;
            font-size: 0.875rem;
            outline: none;
            transition: all 0.2s;
        }
        .input-modern:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .pulse-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        .pulse-dot.online { background-color: #10b981; animation: pulse-green 2s infinite; }
        .pulse-dot.offline { background-color: #ef4444; }

        @keyframes pulse-green {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 6px rgba(16, 185, 129, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }

        .sidebar-item.active { background: rgba(99, 102, 241, 0.05); border-color: rgba(99, 102, 241, 0.2); }
        .font-mono-number { font-feature-settings: "tnum"; font-variant-numeric: tabular-nums; }
        .toast-enter-active, .toast-leave-active { transition: all 0.3s ease; }
        .toast-enter-from, .toast-leave-to { opacity: 0; transform: translateX(30px); }
    </style>
</head>
<body class="h-screen overflow-hidden antialiased">

    <div class="fixed inset-0 z-0 pointer-events-none bg-grid"></div>

    <div id="app" class="relative z-10 flex w-full h-full" v-cloak>
        
        <aside class="w-80 bg-white/90 backdrop-blur-md border-r border-slate-200 flex flex-col z-20 shadow-sm">
            <div class="p-6 border-b border-slate-100">
                <div class="flex items-center gap-3 mb-5">
                    <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center shadow-lg">
                        <i data-lucide="bar-chart-3" class="text-white w-5 h-5"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-lg text-slate-800">Economy Core</h1>
                        <div class="flex items-center gap-2 mt-0.5">
                            <span class="pulse-dot" :class="serverStatus ? 'online' : 'offline'"></span>
                            <span class="text-[10px] font-medium uppercase" :class="serverStatus ? 'text-emerald-600' : 'text-red-600'">
                                {{ serverStatus ? '系统在线' : '连接断开' }}
                            </span>
                        </div>
                    </div>
                </div>
                
                <div class="relative group">
                    <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-slate-400"></i>
                    <input v-model="searchQuery" placeholder="搜索物品 ID / 名称..." class="input-modern pl-10 h-10 text-sm">
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-3 space-y-1">
                <div v-for="item in filteredItems" :key="item.id" 
                     @click="selectItem(item)"
                     class="sidebar-item group p-3 rounded-xl cursor-pointer border border-slate-100 hover:bg-white transition-all"
                     :class="{'active border-indigo-100 bg-indigo-50/50': activeItem.id === item.id}">
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-semibold text-sm text-slate-700">{{ item.name }}</span>
                        <span class="text-[10px] font-mono bg-slate-100 px-1.5 py-0.5 rounded text-slate-500">{{ item.id }}</span>
                    </div>
                    <div class="flex justify-between items-center text-[10px] font-mono-number text-slate-500">
                        <span><i data-lucide="layers" class="w-3 h-3 inline"></i> {{ Math.round(item.n) }}</span>
                        <span class="text-amber-600"><i data-lucide="coins" class="w-3 h-3 inline"></i> {{ item.basePrice }}</span>
                    </div>
                </div>
            </div>

            <div class="p-4 bg-slate-50 border-t border-slate-200">
                <div class="grid grid-cols-2 gap-2 text-[10px] font-mono-number text-slate-500">
                    <div class="bg-white p-2 rounded-lg border border-slate-200 flex flex-col items-center">
                        <span class="text-slate-400">系统总交易</span>
                        <span class="text-indigo-600 font-bold">{{ metrics.totalTrades }}</span>
                    </div>
                    <div class="bg-white p-2 rounded-lg border border-slate-200 flex flex-col items-center">
                        <span class="text-slate-400">活跃玩家</span>
                        <span class="text-rose-600 font-bold">{{ metrics.activePlayers }}</span>
                    </div>
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col relative bg-slate-50/50">
            <header class="h-16 border-b border-slate-200 bg-white/80 backdrop-blur-xl flex justify-between items-center px-8 z-10 shadow-sm">
                <div class="flex gap-2 p-1 bg-slate-100 rounded-xl border border-slate-200">
                    <button @click="currentTab = 'simulation'" class="px-4 py-1.5 rounded-lg text-sm font-medium" :class="currentTab === 'simulation' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500'">核心分析</button>
                    <button @click="currentTab = 'config'" class="px-4 py-1.5 rounded-lg text-sm font-medium" :class="currentTab === 'config' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500'">生产配置</button>
                </div>

                <div class="flex items-center gap-6">
                    <div class="flex flex-col items-end mr-4">
                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">验证模式</span>
                        <div class="flex items-center gap-2 mt-1">
                            <span v-if="config" :class="config.isOnlineMode ? 'text-indigo-600 bg-indigo-50' : 'text-slate-500 bg-slate-100'" 
                                  class="text-[10px] font-bold px-2.5 py-1 rounded-lg border border-current opacity-80">
                                <i :data-lucide="config.isOnlineMode ? 'shield-check' : 'shield-alert'" class="w-3 h-3 inline mr-1"></i>
                                {{ config.isOnlineMode ? 'MOJANG AUTH' : 'OFFLINE MODE' }}
                            </span>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter">模拟 UUID/玩家名</p>
                        <input v-model="playerId" class="text-xs font-mono border-none bg-transparent text-right text-indigo-600 focus:ring-0 p-0 w-32" placeholder="Player ID">
                    </div>
                    <div class="w-px h-8 bg-slate-200"></div>
                    <div class="flex flex-col items-end">
                        <span class="text-[10px] font-bold text-slate-400 uppercase">环境指数 ε</span>
                        <span class="text-2xl font-mono-number font-bold text-amber-600 tracking-tight">{{ currentEnv.toFixed(4) }}</span>
                    </div>
                </div>
            </header>

            <div class="flex-1 overflow-hidden relative p-6">
                <div v-show="currentTab === 'simulation'" class="absolute inset-0 p-6 flex gap-6">
                    <div class="w-96 flex flex-col gap-6">
                        <div class="glass-card rounded-2xl p-6">
                            <div class="flex justify-between items-start mb-4">
                                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest">目标状态</h3>
                                <span class="text-[9px] bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded-full font-bold">LIVE</span>
                            </div>
                            <div v-if="activeItem.id">
                                <div class="text-xl font-bold text-slate-800 mb-4">{{ activeItem.name }}</div>
                                <div class="space-y-4">
                                    <div class="grid grid-cols-2 gap-3">
                                        <div class="bg-white p-3 rounded-xl border border-slate-200 shadow-sm">
                                            <div class="text-[10px] text-slate-400 uppercase font-bold mb-1">即时成交价</div>
                                            <div class="text-lg font-mono-number font-bold text-indigo-600">{{ currentPrice.toFixed(2) }}</div>
                                        </div>
                                        <div class="bg-white p-3 rounded-xl border border-slate-200 shadow-sm">
                                            <div class="text-[10px] text-slate-400 uppercase font-bold mb-1">有效权重 n_eff</div>
                                            <div class="text-lg font-mono-number font-bold text-slate-800">{{ simN.toFixed(2) }}</div>
                                        </div>
                                    </div>
                                    
                                    <div class="bg-indigo-50/50 p-4 rounded-xl border border-indigo-100">
                                        <label class="text-[10px] text-indigo-500 font-bold uppercase block mb-2">特别调整项 (ι)</label>
                                        <input type="number" v-model.number="iota" step="10" class="input-modern h-9 font-mono text-xs" placeholder="物价偏移量">
                                        <p class="text-[9px] text-indigo-400 mt-2">用于模拟全服库存短缺或过剩。</p>
                                    </div>
                                </div>
                            </div>
                            <div v-else class="py-10 text-center text-slate-300 text-xs border border-dashed border-slate-200 rounded-xl">
                                选择左侧物品开启监控
                            </div>
                        </div>

                        <div class="glass-card rounded-2xl p-6 flex-1 flex flex-col">
                            <h3 class="text-xs font-bold text-slate-400 uppercase mb-6 flex items-center gap-2">
                                <i data-lucide="flask-conical" class="w-4 h-4 text-rose-500"></i> 交易压力测试
                            </h3>
                            <div class="space-y-6 flex-1">
                                <div>
                                    <label class="text-[10px] font-bold text-slate-500 uppercase ml-1">测试交易量 (Δn)</label>
                                    <div class="flex gap-2 mt-1">
                                        <input type="number" v-model.number="tradeAmount" class="input-modern font-mono-number text-indigo-600 flex-1">
                                        <button @click="tradeAmount = 64" class="px-3 bg-slate-100 text-slate-500 text-xs rounded-lg hover:bg-slate-200">64</button>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <button @click="simulateTrade('buy')" :disabled="!activeItem.id" class="py-3 bg-rose-500 text-white rounded-xl text-xs font-bold shadow-lg hover:bg-rose-600 active:scale-95 disabled:opacity-50 transition-all">
                                        买入 (BUY)
                                    </button>
                                    <button @click="simulateTrade('sell')" :disabled="!activeItem.id" class="py-3 bg-emerald-500 text-white rounded-xl text-xs font-bold shadow-lg hover:bg-emerald-600 active:scale-95 disabled:opacity-50 transition-all">
                                        卖出 (SELL)
                                    </button>
                                </div>
                            </div>

                            <div v-if="simResult" class="mt-8 p-5 bg-slate-900 text-white rounded-2xl shadow-2xl relative overflow-hidden">
                                <div class="absolute top-0 right-0 p-2 opacity-10"><i data-lucide="receipt" class="w-12 h-12"></i></div>
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-[10px] text-slate-400 font-bold uppercase">模拟成交总额</span>
                                    <span class="text-2xl font-mono-number font-bold text-emerald-400">{{ simResult.totalPrice.toFixed(2) }}</span>
                                </div>
                                <div class="h-px bg-white/10 my-3"></div>
                                <div class="flex justify-between items-center text-[10px]">
                                    <span class="text-slate-400">平均单价</span>
                                    <span class="font-mono text-slate-200">{{ simResult.unitPriceAvg.toFixed(4) }}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex-1 glass-card rounded-2xl p-6 flex flex-col border border-slate-200">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-sm font-bold flex items-center gap-2 text-slate-700">
                                <i data-lucide="line-chart" class="w-5 h-5 text-indigo-500"></i> AMM 指数衰减模型
                            </h3>
                            <button @click="fetchMarket" class="text-xs text-indigo-600 font-bold hover:underline">刷新市场快照</button>
                        </div>
                        <div id="priceChart" class="flex-1 bg-white rounded-xl border border-slate-100 p-2"></div>
                    </div>
                </div>

                <div v-show="currentTab === 'config'" class="absolute inset-0 p-8 overflow-y-auto">
                    <div class="max-w-4xl mx-auto space-y-8">
                        <div class="flex justify-between items-center">
                            <div>
                                <h2 class="text-3xl font-bold text-slate-800">系统全局参数</h2>
                                <p class="text-slate-500 text-sm mt-1">控制时间恢复速率与市场基础环境</p>
                            </div>
                            <button @click="saveConfig" class="px-8 py-3 bg-slate-900 text-white rounded-2xl font-bold shadow-xl hover:bg-slate-800 transition-all active:scale-95">同步至服务端</button>
                        </div>
                        <div v-if="config" class="grid grid-cols-2 gap-8">
                            <div class="glass-card p-8 rounded-2xl space-y-6">
                                <h4 class="text-xs font-bold text-indigo-600 uppercase">时间恢复 (Recovery)</h4>
                                <div>
                                    <label class="text-[10px] font-bold text-slate-400 uppercase">恢复率 (δ)</label>
                                    <input v-model.number="config.recoveryDelta" step="0.01" class="input-modern mt-1">
                                </div>
                                <div>
                                    <label class="text-[10px] font-bold text-slate-400 uppercase">时间常数 (τ - 秒)</label>
                                    <input v-model.number="config.recoveryTau" class="input-modern mt-1">
                                </div>
                            </div>
                            <div class="glass-card p-8 rounded-2xl space-y-6">
                                <h4 class="text-xs font-bold text-amber-600 uppercase">市场因子 (Market)</h4>
                                <div>
                                    <label class="text-[10px] font-bold text-slate-400 uppercase">买入溢价 (Buy Premium)</label>
                                    <input v-model.number="config.buyPremium" step="0.05" class="input-modern mt-1">
                                </div>
                                <div>
                                    <label class="text-[10px] font-bold text-slate-400 uppercase">基础环境指数</label>
                                    <input v-model.number="config.baseEnvIndex" step="0.1" class="input-modern mt-1">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <div class="fixed top-6 right-6 z-50 flex flex-col gap-3">
            <transition-group name="toast">
                <div v-for="toast in toasts" :key="toast.id" class="bg-white/95 backdrop-blur border border-slate-200 px-5 py-3.5 rounded-2xl shadow-2xl flex items-center gap-4 min-w-[320px]">
                    <div class="w-8 h-8 rounded-full bg-indigo-50 flex items-center justify-center">
                        <i data-lucide="bell" class="w-4 h-4 text-indigo-600"></i>
                    </div>
                    <span class="text-sm font-semibold text-slate-700">{{ toast.message }}</span>
                </div>
            </transition-group>
        </div>
    </div>

    <script>
        const { createApp, ref, reactive, onMounted, computed, watch } = Vue;

        createApp({
            setup() {
                const serverStatus = ref(false);
                const currentTab = ref('simulation');
                const searchQuery = ref('');
                const playerId = ref('Admin_Tester');
                const iota = ref(0);
                const config = ref(null);
                const items = ref([]);
                const activeItem = reactive({ id: '', name: '', basePrice: 0, n: 0, lambda: 0 });
                const simN = ref(0);
                const currentEnv = ref(1.0);
                const currentPrice = ref(0);
                const tradeAmount = ref(64);
                const simResult = ref(null);
                const toasts = ref([]);
                const metrics = reactive({ totalTrades: 0, activePlayers: 0 });
                let myChart = null;

                const filteredItems = computed(() => {
                    const q = searchQuery.value.toLowerCase();
                    return items.value.filter(i => i.name.toLowerCase().includes(q) || i.id.toLowerCase().includes(q));
                });

                const showToast = (message) => {
                    const id = Date.now();
                    toasts.value.push({ id, message });
                    setTimeout(() => toasts.value = toasts.value.filter(t => t.id !== id), 3000);
                };

                const selectItem = async (item) => {
                    Object.assign(activeItem, item);
                    simN.value = item.n; 
                    simResult.value = null;
                    await syncPreviewData();
                };

                // 从后端同步真实的有效 N 和当前环境指数
                const syncPreviewData = async () => {
                    if(!activeItem.id) return;
                    try {
                        const res = await axios.post('/calculate_sell', {
                            playerId: playerId.value,
                            playerName: playerId.value,
                            itemId: activeItem.id,
                            basePrice: activeItem.basePrice,
                            amount: 0.0001, // 极小量模拟获取当前 n_eff
                            decayLambda: activeItem.lambda,
                            iota: iota.value,
                            isPreview: true
                        });
                        simN.value = res.data.effectiveN;
                        currentEnv.value = res.data.envIndex;
                        updatePrice();
                        renderChart();
                    } catch (e) { console.error("Sync error", e); }
                };

                const updatePrice = () => {
                    // P = ε * P0 * e^(-λ * (n + ι))
                    currentPrice.value = currentEnv.value * activeItem.basePrice * Math.exp(-activeItem.lambda * (simN.value + iota.value));
                };

                watch(iota, updatePrice);

                const simulateTrade = async (type) => {
                    if (!activeItem.id) return;
                    try {
                        const res = await axios.post(`/calculate_${type}`, {
                            playerId: playerId.value,
                            playerName: playerId.value,
                            itemId: activeItem.id,
                            basePrice: activeItem.basePrice,
                            amount: tradeAmount.value,
                            decayLambda: activeItem.lambda,
                            iota: iota.value,
                            isPreview: true
                        });
                        
                        simResult.value = res.data;
                        const startN = res.data.effectiveN;
                        // 如果是卖出，点向右移；买入点向左移
                        simN.value = type === 'sell' ? startN + tradeAmount.value : Math.max(0, startN - tradeAmount.value);
                        
                        updatePrice();
                        renderChart(type, startN, tradeAmount.value);
                        showToast(`模拟${type === 'sell' ? '卖出' : '买入'}成功 (预览模式)`);
                    } catch (e) { 
                        showToast("模拟失败：身份验证被后端拒绝"); 
                    }
                };

                const renderChart = (action, startN, amount) => {
                    if (!myChart || !activeItem.id) return;
                    const data = [];
                    const maxN = Math.max(simN.value * 2, 2.0 / activeItem.lambda);
                    const step = maxN / 120;
                    
                    for(let x=0; x<=maxN; x+=step) {
                        data.push([x, currentEnv.value * activeItem.basePrice * Math.exp(-activeItem.lambda * (x + iota.value))]);
                    }

                    const option = {
                        grid: { top: 40, right: 30, bottom: 40, left: 60 },
                        tooltip: { 
                            trigger: 'axis', 
                            formatter: (p) => `权重 N: ${p[0].value[0].toFixed(2)}<br/>价格: ${p[0].value[1].toFixed(2)}` 
                        },
                        xAxis: { type: 'value', name: 'N', splitLine: { lineStyle: { color: '#f1f5f9' } } },
                        yAxis: { type: 'value', name: 'Price', splitLine: { lineStyle: { color: '#f1f5f9' } } },
                        series: [{
                            name: '价格曲线',
                            type: 'line', smooth: true, data, showSymbol: false,
                            lineStyle: { color: '#6366f1', width: 3 },
                            areaStyle: { color: 'rgba(99,102,241,0.05)' }
                        }, {
                            name: '当前价格',
                            type: 'effectScatter', data: [[simN.value, currentPrice.value]],
                            symbolSize: 14, itemStyle: { color: '#fbbf24', borderColor: '#fff', borderWidth: 2 }
                        }]
                    };

                    if(action) {
                        const x0 = action === 'buy' ? Math.max(0, startN - amount) : startN;
                        const x1 = action === 'buy' ? startN : startN + amount;
                        option.series[0].markArea = {
                            itemStyle: { color: action === 'buy' ? 'rgba(244,63,94,0.1)' : 'rgba(16,185,129,0.1)' },
                            data: [[{ xAxis: x0 }, { xAxis: x1 }]]
                        };
                    }
                    myChart.setOption(option, true);
                };

                const fetchMarket = async () => {
                    try {
                        const res = await axios.get('/api/market');
                        items.value = res.data;
                        serverStatus.value = true;
                    } catch { serverStatus.value = false; }
                };

                const fetchConfig = async () => {
                    try {
                        const res = await axios.get('/api/config');
                        config.value = res.data;
                    } catch(e) {}
                };

                const saveConfig = async () => {
                    try {
                        await axios.post('/api/config', config.value);
                        showToast("配置已持久化");
                    } catch { showToast("保存失败"); }
                };

                const fetchMetrics = async () => {
                    try {
                        const res = await axios.get('/api/metrics');
                        metrics.totalTrades = res.data.total_trades;
                        metrics.activePlayers = res.data.active_players;
                    } catch(e) {}
                };

                onMounted(() => {
                    lucide.createIcons();
                    myChart = echarts.init(document.getElementById('priceChart'));
                    fetchMarket();
                    fetchConfig();
                    setInterval(fetchMetrics, 3000);
                    window.addEventListener('resize', () => myChart.resize());
                });

                return {
                    serverStatus, currentTab, searchQuery, playerId, config, items, filteredItems,
                    activeItem, simN, currentEnv, currentPrice, tradeAmount, simResult, toasts, metrics, iota,
                    selectItem, simulateTrade, saveConfig, fetchMarket
                };
            }
        }).mount('#app');
    </script>
</body>
</html>